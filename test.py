#!/usr/bin/env python
# this script requires Python3, numpy, scipy, matplotlib, and xraydb modules. Use:
#        pip install xraydb scipy matplotlib
import numpy as np
import matplotlib.pyplot as plt
import xraydb

# X-ray attenuation calculations
# inputs from web form
formula = 'Fe'  # material chemical formula
density = 7.88  # material density in gr/cm^3
thickness = 1.000000  # material thickness, in mm
energy = np.arange(100, 50000+50, 50)

mu_array = xraydb.material_mu(formula, energy, density=density)

atten_length = 10.0 / mu_array

trans_fract = np.exp(-0.1*thickness*mu_array)
atten_fract = 1 - trans_fract

import pandas as pd

data = {
    'energy':energy,
    'atten_length':atten_length,
    'trans_fract':trans_fract,
    'atten_fract':atten_fract
}

df = pd.DataFrame(data)
# print(df)
# df.to_csv('output.csv')


# plt.plot(energy, atten_length, label='1/e length (mm)')
# plt.xlabel('Energy (eV)')
# plt.ylabel('1/e length (mm)')
# plt.title('1/e length for %s' % formula)
# plt.show()
# plt.subplot(2, 2, 1)
# plt.plot(energy, trans_fract, label='transmitted')
# plt.plot(energy, atten_fract, label='attenuated')
# plt.xlabel('Energy (eV)')
# plt.ylabel('tranmitted fraction')
# plt.title('transmission for %s' % formula)
# plt.legend()
# plt.show()

from xpecgen import xpecgen as xg

#Define some parameters
E0=100
theta=12

#Calculate a spectrum
#s=xg.calculate_spectrum(E0,theta,3,150,epsrel=0.5)
s=xg.calculate_spectrum(E0, 90, e_min=3, num_e=100)

#Get some functions to study the spectrum
fluence_to_dose=xg.get_fluence_to_dose()
mu_Al=xg.get_mu(13)
mu_Cu=xg.get_mu(29)

#Normalize the spectrum in the sense of dose
s.set_norm(value=1,weight=fluence_to_dose)
#Get the norms
print("Number of photons:",s.get_norm())
print("Energy:",s.get_norm(lambda x:x),"keV")
print("Dose:",s.get_norm(fluence_to_dose),"Gy")

print(s.x)

#Export the spectrum as an Excel document
#s.export_csv(str(E0)+"keV.csv")

#plt.plot(numpy.array(s2.x), numpy.array(s2.y), label='Energy')
# plt.subplot(2, 2, 2)
# energy_values = [3.0,3.651006711409396,4.302013422818792,4.953020134228188,5.604026845637584,6.25503355704698,6.906040268456375,7.557046979865771,8.208053691275168,8.859060402684563,9.51006711409396,10.161073825503355,10.81208053691275,11.463087248322147,12.114093959731543,12.765100671140939,13.416107382550335,14.06711409395973,14.718120805369127,15.369127516778523,16.02013422818792,16.671140939597315,17.32214765100671,17.973154362416107,18.6241610738255,19.2751677852349,19.926174496644293,20.57718120805369,21.228187919463085,21.879194630872483,22.530201342281877,23.181208053691275,23.83221476510067,24.483221476510064,25.13422818791946,25.785234899328856,26.436241610738254,27.087248322147648,27.738255033557046,28.38926174496644,29.040268456375838,29.691275167785232,30.34228187919463,30.993288590604024,31.644295302013422,32.29530201342281,32.946308724832214,33.59731543624161,34.248322147651,34.899328859060404,35.5503355704698,36.20134228187919,36.85234899328859,37.50335570469798,38.15436241610738,38.80536912751678,39.45637583892617,40.107382550335565,40.758389261744966,41.40939597315436,42.060402684563755,42.71140939597315,43.36241610738255,44.013422818791945,44.66442953020134,45.31543624161073,45.96644295302013,46.61744966442953,47.26845637583892,47.91946308724832,48.57046979865771,49.22147651006711,49.87248322147651,50.5234899328859,51.174496644295296,51.8255033557047,52.47651006711409,53.127516778523486,53.77852348993288,54.42953020134228,55.080536912751676,55.73154362416107,56.382550335570464,57.03355704697986,57.65,57.68456375838926,57.87222222222222,58.09444444444444,58.31666666666666,58.335570469798654,58.538888888888884,58.76111111111111,58.983333333333334,58.98657718120805,59.205555555555556,59.42777777777778,59.63758389261744,59.65,60.288590604026844,60.93959731543624,61.59060402684563,62.24161073825503,62.89261744966443,63.54362416107382,64.19463087248322,64.84563758389261,65.496644295302,66.14765100671141,66.244,66.46622222222223,66.68844444444444,66.79865771812081,66.91066666666667,67.13288888888889,67.35511111111111,67.4496644295302,67.57733333333333,67.79955555555556,68.02177777777777,68.067,68.1006711409396,68.244,68.28922222222222,68.51144444444444,68.73366666666666,68.75167785234899,68.95588888888888,69.17811111111111,69.40033333333332,69.40268456375838,69.62255555555555,69.84477777777776,70.05369127516778,70.067,70.70469798657717,71.35570469798657,72.00671140939596,72.65771812080537,73.30872483221476,73.95973154362416,74.61073825503355,75.26174496644295,75.91275167785234,76.56375838926174,77.21476510067113,77.86577181208052,78.51677852348993,79.16778523489933,79.81879194630872,80.46979865771812,81.12080536912751,81.7718120805369,82.4228187919463,83.07382550335569,83.7248322147651,84.3758389261745,85.02684563758389,85.67785234899328,86.32885906040268,86.97986577181207,87.63087248322147,88.28187919463086,88.93288590604026,89.58389261744966,90.23489932885906,90.88590604026845,91.53691275167785,92.18791946308724,92.83892617449663,93.48993288590603,94.14093959731542,94.79194630872483,95.44295302013423,96.09395973154362,96.74496644295301,97.39597315436241,98.0469798657718,98.6979865771812,99.34899328859059,100.0]
# intensities = [4.79108562255995e-113,8.085052819709741e-64,4.910839890771208e-38,2.4663625410571336e-23,2.5680128871785358e-14,1.662072962551354e-08,0.00014039293147946665,0.07542627565806087,6.9543808356995145,200.3392238330677,2520.1612070616816,17415.958968091505,32416.46974408928,111357.12780850727,184054.8763448473,418260.3313018616,825968.8913590702,1456362.1664924724,2349911.8239333015,3519936.416222975,4970282.406856749,6679405.547986465,8629246.591354145,10751440.41663707,13049887.226057703,15439252.95251259,17893393.369176507,20209003.79952799,22467459.502512798,24638139.74591912,26755479.429314386,28746929.37818377,30630430.42624892,32419243.201154336,33828770.43026246,35407113.764750496,36684684.255714856,37817190.54360031,38845779.116837524,39708052.89993862,40400800.59709532,40978046.558875516,41392202.57634905,41619800.5236244,41742614.862709545,41817294.963072516,41820067.63631023,41744977.002929024,41603181.33617231,41433461.581091076,41197496.16967664,40926438.01331252,40611071.15715381,40259308.6545145,39890099.72081026,39453858.76582587,39000700.50765558,38558321.77921771,38072699.10008991,37566028.744042,37029400.63811245,36464557.96447191,35834816.99452803,35489995.931591995,34690980.31181222,34122165.99202078,33521451.928028885,32936120.435445763,32371294.5235097,31847463.13670528,31356848.723278016,30779447.924780976,30222920.998326294,29674194.50271666,29140966.57797101,28575458.41873307,28057504.739489593,27536722.91360045,26975822.086003374,26458387.887677856,25946247.403141093,25531968.67659129,24921549.44216106,24375034.34898819,23916314.32490466,24967356.4417644,30670752.568383772,37424625.19199819,44178497.81561261,44753030.26866169,50941358.57622391,50782181.32986663,43700130.392429754,43596751.460960664,36586564.749092385,29472532.260971554,22755978.433680475,22359921.563443817,21883722.75955225,21405337.178502046,20925914.984862443,20484536.731949817,19988238.054763142,19518867.481298428,19119153.498838153,18675714.473934382,18313255.82878608,17820198.67589283,17766075.33236613,19207329.361490764,20648583.390615303,21363387.35198613,22088374.825913005,23526727.115001157,23398993.66409702,22678290.650241636,21699462.53924672,19995701.07878723,18291939.618327856,17945224.161124364,17768222.905467506,17020194.80638361,17102880.122525036,17509196.172360033,17915512.222195055,17948444.27438185,18297623.535837825,18142008.429293077,17450801.733299352,17443488.395338025,16206439.220176797,14956161.434755769,13780761.862879654,13743320.053822726,13486221.96427541,13217921.560684998,12943049.369253619,12624937.688690517,12349946.042935522,12047351.48291967,11753654.028516827,11466054.224077087,11208382.410551125,10933094.417682953,10672990.29356347,10390005.131537301,10095075.4077081,9829128.161191028,9542135.927652627,9269643.533367123,8999588.569681406,8711095.115470672,8446194.437279215,8174529.4571275525,7935791.948110195,7662277.3422750905,7393840.546897871,7099221.828515332,6844363.163772226,6575481.166724174,6318903.727989042,6036486.817004305,5774890.873702642,5504719.392642397,5228223.962274052,4953148.132410868,4689952.789664401,4410938.788445606,4135414.2075588955,3850240.501593072,3566026.034624167,3271789.2408459852,2970598.104686994,2664508.3228175594,2346713.0944205383,1975896.588477615,1617188.862623692,1270243.0095459542,651658.955622827,0.0]
# plt.plot(energy_values, intensities, label='Energy')
# plt.xlabel('Energy (keV)')
# plt.ylabel('Intensity')
# plt.title('X-ray Spectrum')
# plt.legend()
# plt.grid(True)
# plt.show()